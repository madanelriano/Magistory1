name: AI Code Runner
on: [push] # Berjalan otomatis setiap kali agen melakukan push

jobs:
  test_code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Script and Capture Output
        id: run_script
        run: |
          # Jalankan file utama (asumsi agen selalu update main.py)
          python3 main.py > result.txt 2>&1 || echo "ERROR" > error_flag.txt
          echo "FINAL_OUTPUT=$(cat result.txt)" >> $GITHUB_ENV

      - name: Notify n8n Webhook
        if: always() # Tetap kirim laporan meskipun kode error
        run: |
          curl -X POST "https://fillaramadhan.app.n8n.cloud/webhook-test/github-result" \
          -H "Content-Type: application/json" \
          -d "{
            \"status\": \"${{ steps.run_script.outcome }}\",
            \"output\": \"${{ env.FINAL_OUTPUT }}\",
            \"repo\": \"${{ github.repository }}\"
          }"
